<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Flockcursor</title>
  <link rel="stylesheet" href="http://yui.yahooapis.com/pure/0.5.0/pure-min.css">
  <style>  
* {
	-webkit-box-sizing: border-box;
	-moz-box-sizing: border-box;
	box-sizing: border-box;
}

a {
	text-decoration: none;
	color: rgb(61, 146, 201);
}

.sidebar {
	background: rgb(61, 79, 93);
	margin-left: 80%;
	width: 20%;
	height: 100%;
	position: fixed;
	color: #fff;
}

p {
	font-size:10px;
}

/*canvas area*/
.content-main {
	position: fixed;
	width: 80%;
	height: 100%;
	overflow: scroll;
}

/*chat box*/
#interface {
	overflow-y: scroll;
	overflow-x: hidden;
	word-wrap: break-word;
	background-color: black;
	margin: 5%;
	width: 90%;
	height: 50%;
}

#chat-prompt {
	margin-left: 5%;
	width: 90%;
}

#name {
	margin-left: 5%;
	width: 90%;
}

#online {
	margin-left: 5%;
}

.footer {
	text-align: center;
	padding: 1em 0;
}
.footer a {
	color: #ccc;
	font-size: 80%;
}

@media (min-width: 48em) {
	.content {
		padding: 1em 1em 0;
		margin-left: 15%;
	}

	.header {
		margin: 8% 2em 0;
		text-align: right;
	}

	.sidebar {
		position: fixed;
		top: 0;
		bottom: 0;
	}
}
</style>

  <script type="text/javascript" src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.13/fabric.min.js"></script>
  <script type="text/javascript" charset="utf-8">
var socket;

var sanitize = function(message) {
    if(message != null)
	return message.replace('<', '#');
}

$(document).ready(function() {
    
    var cursors = new Object(); 

    var canvas = new fabric.Canvas('main-area');
    socket = io.connect('http://' + document.domain + ':' + location.port);

    /*when user joins they will have chat access*/
    socket.on('join', function() {
	document.getElementById('chat-prompt').disabled = false;
    });

    /*user gets a chat name. triggers 'joined' python function*/
    socket.on('connect', function() {
	var input = sanitize(prompt("Enter your nickname!", ""));
	socket.emit('joined', {name : input});
    });

    socket.on('draw_all', function(e) {
	for (var key in e.players){
	    cursors[key] = new fabric.Group(
		[new fabric.Circle({ radius : 10, 
				     fill:'#f55'}),
		 new fabric.Text(key, { fontSize: 10,
					originX: 'center',
					originY: 'center'})],
				    { left : e.players[key][0], top : e.players[key][1] });
	    cursors[key].lockMovementX = cursors[key].lockMovementY = true;
	    cursors[key].lockRotation = true;
	    cursors[key].lockScalingX = cursors[key].lockScalingY = true;
	    cursors[key].hasBorders = cursors[key].hasControls = false;		    
	    canvas.add(cursors[key]);
	}
    });

    socket.on('remove', function(e) {
	delete cursors[e.user];
	canvas.renderAll();
    });

    /*when user types in chat*/
    $('#chat-prompt').keypress(function(e) {
	var code = e.keyCode || e.which;
	if (code == 13) {
	    text = sanitize($('#chat-prompt').val());
	    $('#chat-prompt').val('')

	    socket.emit('user_msg', {message: text});
	}
    });

    /*when user types in nickname area*/
    $('#name').keypress(function(e) {
	var code = e.keyCode || e.which;
	if (code == 13) {
	    text = sanitize($('#name').val());
	    $('#name').val('');
	    socket.emit('change_name', {new: text});
	}
    });

    /*updates chat and users online*/
    socket.on('msg', function(data) {
	var new_msg = document.createElement('p');
	if (data.message != undefined) {
	    new_msg.innerHTML = data.message;
	    $('#interface').append(new_msg);
	}
	if (data.online != undefined) {
	    document.getElementById("online").innerHTML = data.online + " user(s) online";
	}	
	/*Auto Scroll*/
	$('#interface').scrollTop($('#interface')[0].scrollHeight);

    });

    $('canvas').mousemove(function(e) {
	x = e.pageX;
	y = e.pageY;
	socket.emit('mouse_move', {top : x , left : y});
    });

    socket.on('move_clientmouse', function(e){
        console.log(e.user);
	cursors[e.user].set('left' , e.x);
	cursors[e.user].set('top' , e.y);
	console.log(e.user);			    
	canvas.renderAll();
    });
});

</script>
</head>

<body style="overflow: hidden;">
	<div class="sidebar" style="height: 100%;">
		<div class="chat-room" style="height: 100%;">
			<div id="interface"></div>
			<textarea id="chat-prompt" placeholder="send a message" disabled="true"></textarea>
			<input id="name" name="nick" placeholder="enter your nick here">
			<div id="online"></div>
		</div>
	</div>

	<div class="content-main"><center>
		<canvas id="main-area" width="1200" height="800"
			style="border:1px solid #000000;">
		</canvas> </center>
	</div>
</body>
</html>
